import _ from "lodash";
import dayjs from "dayjs";
import $ from "jquery";
import { iStorage } from "./tools/storage";

/* ÁªÑ‰ª∂Â±ûÊÄßÊòØÂê¶ÊòØonÂºÄÂ§¥ÔºåÁªÑ‰ª∂ÁöÑ‰∫ã‰ª∂ÁõëÂê¨*/
const onRE = /^on[^a-z]/;

const VueComponents: any = {};

const privateLodash = {
	..._,
	WORDS: {
		INVALID_DATE: "Invalid Date",
		format_ymd: "YYYY-MM-DD"
	},
	/* ‰ªéjQueryÂØπË±°‰∏≠ÔºåËé∑ÂèñleftTopÁöÑÊï∞ÂÄº */
	getLeftTopFromAbsolute($ele: JQuery) {
		const _top = $ele.css("top");
		const _left = $ele.css("left");
		const getNum = (x: string) => {
			const match = String(x).match(/^(.*)px$/);
			/* @ts-ignore */
			if (match && match[1]) {
				/* @ts-ignore */
				return Number(match[1]);
			} else {
				return 0;
			}
		};
		const top = getNum(_top);
		const left = getNum(_left);
		console.log(left, top);
		return { top, left };
	},
	getLeftTopFromTranslate($ele: JQuery) {
		const transform = $ele.css("transform");
		const match = String(transform).match(/^matrix\((.*)\)$/);
		if (!match) {
			return { top: 0, left: 0 };
		}
		/* @ts-ignore */
		if (match && match[1]) {
			/* @ts-ignore */
			const [a, b, c, d, e, f] = String(match[1])
				.split(",")
				.map(i => Number(privateLodash.trim(i)));

			return {
				left: a + c + e,
				top: b + d + f
			};
		}
	},
	/**
	 * Áî®‰∫éBoundless Ëß£Êûêvue SFCÊñá‰ª∂
	 * @param {*} code
	 * @returns
	 */
	async asyncImportSFC(
		url: string,
		/* window.Vue */
		__Vue: object
	): Promise<object> {
		if (VueComponents[url]) {
			return VueComponents[url];
		}
		const scfSourceCode = await privateLodash.asyncLoadText(url);
		const scfObjSourceCode = privateLodash.VueLoader(scfSourceCode);
		VueComponents[url] = await privateLodash.getVueComponentBySourceCode(
			url,
			scfObjSourceCode,
			__Vue
		);
		return VueComponents[url];
	},
	async getVueComponentBySourceCode(
		url: string,
		scfObjSourceCode: string,
		__Vue: object
	): Promise<object> {
		const scfObjAsyncFn = new Function(
			"argVue",
			"argPayload",
			`console.log(\`${url}\`)\nreturn (${scfObjSourceCode})(argVue,argPayload);`
		);
		const scfObj = await scfObjAsyncFn(__Vue, {
			url
		});
		return scfObj;
	},
	/* * @parseContentÔºöÊª°Ë∂≥`return {}`ÂΩ¢ÂºèÁöÑÂ≠óÁ¨¶‰∏≤ */
	parseContent: (returnSentence: string) => {
		if (!returnSentence) return;
		return new Function(`${returnSentence} return module();`);
	},
	payloadIdCount: 1,
	payloadIdCountMax: 40000,
	payloadDateNow: Date.now(),
	genId: (category: string) => {
		const { payloadIdCount, payloadIdCountMax, payloadDateNow } = privateLodash;
		if (payloadIdCount > payloadIdCountMax) {
			privateLodash.payloadIdCount = 1;
			privateLodash.payloadDateNow = Date.now();
		}
		return `${category}_${payloadDateNow}_${privateLodash.payloadIdCount++}`;
	},
	VueLoader: (code: string) => {
		function getSource(source: string, type: string) {
			var regex = new RegExp("<" + type + "[^>]*>");
			var openingTag: any = source.match(regex);
			if (!openingTag) return "";
			else openingTag = openingTag[0];
			var targetSource = source.slice(
				source.indexOf(openingTag) + openingTag.length,
				source.lastIndexOf("</" + type + ">")
			);
			return type === "template"
				? targetSource.replace(/`/g, "\\`")
				: targetSource;
		}

		function splitCode() {
			if (!/TEMPLATE_PLACEHOLDER/.test(code)) {
				alert("SFC miss TEMPLATE_PLACEHOLDER");
				console.error(code);
			}
			return getSource(code, "script").replace(
				/TEMPLATE_PLACEHOLDER/,
				`template: \`${getSource(code, "template")}\``
			);
		}

		return splitCode();
	},
	/**
	 * async ÊâßË°åjsx module Êñá‰ª∂
	 * @param {*} url
	 */
	async asyncExecFnString(url: string) {
		const data = await privateLodash.asyncLoadText(url);
		return privateLodash.parseContent(data);
	},
	/*lodash IDE ËÉΩËØÜÂà´*/
	doNothing: (...args: any[]) => {
		if (localStorage.isShowDevLog) {
			const e = new Error();
			console.log("üöÄ:", e?.stack?.split("\n")[2].replace("    at ", ""));
			console.log.apply(console, args);
		}
	},
	/* Áù°Áú† t:setTimeout during time*/
	sleep: (t: number) => new Promise(r => setTimeout(r, t)),
	isOn: (key: string) => onRE.test(key),
	isModelListener: (key: string) => {
		key = String(key);
		if (!key) {
			return false;
		}
		return key.startsWith("onUpdate:");
	},
	isListener: (key: any) => {
		key = String(key);
		if (!key) {
			return false;
		}
		return privateLodash.isOn(key) || privateLodash.isModelListener(key);
	},
	/*ÊòØÂê¶ÈùûÁ©∫Êï∞ÁªÑ*/
	isArrayFill: (arr: any) => {
		if (Array.isArray(arr)) {
			if (arr.length > 0) {
				return true;
			}
		}
		return false;
	},
	/*ÂØπË±°Ëá≥Â∞ëÊúâ‰∏Ä‰∏™Â±ûÊÄß*/
	isObjectFill: (obj: any) =>
		privateLodash.isPlainObject(obj) && Object.keys(obj).length > 0,
	/***
	 * ËøîÂõûÊï∞ÁªÑÁöÑÁ¨¨‰∏Ä‰∏™valueÔºå
	 * ÈÄöËøácheck,
	 * ‰∏∫ÁúüÂàôËøîÂõûvalue,
	 * Âê¶ÂàôËøîÂõûfalse,
	 * ÈªòËÆ§check‰∏∫ xU.isInput
	 * @param arr
	 * @param fnCheck
	 * @return {firstValue|false}
	 */
	safeFirst: (arr: any[], fnCheck: Function) => {
		fnCheck = fnCheck || ((value: any) => privateLodash.isInput(value));
		const obj = privateLodash.first(arr);
		return fnCheck(obj) ? obj : false;
	},
	/***
	 *
	 * @param val
	 * @param isBeautiful
	 * @return {string}
	 */
	safeToString: (val: object, isBeautiful = false) => {
		try {
			if (isBeautiful) {
				return JSON.stringify(val, null, 2);
			} else {
				return JSON.stringify(val);
			}
		} catch (error) {
			return "";
		}
	},
	safeParse: (val: string, defaultObj: {}) => {
		let obj = defaultObj;
		try {
			obj = JSON.parse(val);
			if (!val) {
				obj = defaultObj;
				throw new Error("json parse error");
			}
		} catch (error) {
			privateLodash.doNothing(error);
		}
		return obj;
	},

	safeSplit: (target: string, sp = "") => {
		return target?.split ? target.split(sp) : [];
	},
	/***
	 * dayjsÂØπË±°ÊàñËÄÖ""
	 * @param val
	 * @return {string|dayjs.Dayjs}
	 */
	safeDate: (val: dayjs.ConfigType) => {
		if (!val) {
			return "";
		}
		let date = dayjs(val);
		/* @ts-ignore */
		if (date === privateLodash.WORDS.INVALID_DATE) {
			return "";
		} else {
			return date;
		}
	},
	/*  */

	/***
	 * false 0 ÈÉΩÁÆóÂ∑≤ËæìÂÖ•
	 * @param val {any}
	 * @returns {boolean}
	 */
	isInput: (val: any) => {
		if (val === undefined) {
			return false;
		}
		val = JSON.parse(JSON.stringify(val));
		if (val === 0) {
			return true;
		}
		if (val === false) {
			return true;
		}
		if (privateLodash.isArray(val)) {
			return val.length > 0;
		} else if (val) {
			return true;
		}
		return false;
	},
	/*jqueryÂà∞Â∫ïÊúâÊ≤°ÊúâÈÄâ‰∏≠ÁõÆÊ†áDOMÔºü*/
	is$Selected: ($ele: JQuery) => $ele && $ele.jquery && $ele.length > 0,
	/**
	 * Ëé∑ÂèñÂØπË±°ÁöÑÈîÆÂíåÂÄº
	 * Ëøô‰∏™ÊñπÊ≥ïÂæàÁÅµÊÄßÔºåÊúâÊó∂ÂÄôÂêéÈù¢Êù•ÁöÑÁªìÊûÑÈïøËøôÊ†∑ {id:value}ÔºåÊúâ‰∏îÂè™Êúâ‰∏Ä‰∏™Â±ûÊÄßÔºå
	 * ‰ΩÜÂá°ÂÜô‰∏™Interface ËßÑÂÆöÊï∞ÊçÆÈïøËøôÊ†∑ÔºåÈÄöÁî®ÊÄßÈÉΩÊõ¥Â•Ω
	 * [{
	 *      prop:'id',
	 *      value:'12345',
	 *      label:'ÂîØ‰∏ÄÊ†áËØÜÁ¨¶'
	 * }]
	 * @param {*} obj
	 * @param {*} defaultValue
	 * @returns
	 */
	getObjectFirstKeyValue: (obj: object, defaultValue: "") => {
		if (!obj) {
			return defaultValue;
		}
		const keyArray = Object.keys(obj);
		if (!privateLodash.isArrayFill(keyArray)) return defaultValue;
		const prop = keyArray[0];
		/* @ts-ignore */
		return privateLodash.isInput(prop) && obj[prop] ? obj[prop] : defaultValue;
	},

	/**
	 * ÂºÇÊ≠•Âä†ËΩΩjs Âú®window‰∏≠Âêç‰∏∫globalNameÁöÑÂÖ®Â±ÄÂèòÈáè
	 * @param {string} url
	 * @param {string} globalName
	 * @returns Âú®window‰∏≠Âêç‰∏∫globalNameÁöÑÂÖ®Â±ÄÂèòÈáè
	 */
	asyncLoadJS: async (url: string, globalName: string) => {
		/* UMD ‰ºöÊö¥Èú≤Âá∫‰∏Ä‰∏™ÂÖ®Â±ÄÂØπË±°ÔºåÊ≠£ÊòØÊ≠§globalName */
		/* @ts-ignore */
		if (window[globalName]) {
			/* @ts-ignore */
			return window[globalName];
		}
		const $style = $("<style/>").attr("id", `asyncLoadJS_${globalName}`);
		$style.appendTo($("body")).on("load", function () {
			/* @ts-ignore */
			return window[globalName];
		});
		$style.attr("src", url);
	},
	ensureValueDone: async (fnGetValue: Function) => {
		return new Promise(async resolve => {
			let exeFnGetValue = async function () {
				const value = await fnGetValue();
				if (value) {
					/* @ts-ignore */
					exeFnGetValue = null;
					resolve(value);
				} else {
					/* @ts-ignore */
					setTimeout(exeFnGetValue, 1000 * exeFnGetValue.count++);
				}
			};
			(exeFnGetValue as any).count = 1;
			exeFnGetValue();
		});
	},
	/* ÁîüÊàêÂêàÊ≥ïÁöÑÈîÆÂêç */
	genProp: (someString: string) => {
		return `k${privateLodash.camelCase(someString)}`;
	},
	/**
	 *
	 * @param {*} url
	 * @returns
	 */
	asyncLoadText: async function (url: string) {
		/* Âú®ÂºÄÂèëÊ®°Âºè‰∏ãApp.vue ‰ºöËÆæÁΩÆËøô‰∏™ÂØπË±° */
		/* @ts-ignore */
		if (!localStorage.___VENTOSE_UI_IS_DEV_MODE) {
			const res = await iStorage(url);
			if (res) {
				return res;
			}
		}
		/* https://learn.jquery.com/ */
		/* https://api.jquery.com/jQuery.ajax/  */
		return new Promise((resolve, reject) =>
			$.ajax({
				type: "GET",
				async: true,
				url,
				dataType: "text",
				success(...args) {
					/* @ts-ignore */
					if (!localStorage.___VENTOSE_UI_IS_DEV_MODE) {
						iStorage(url, args[0]);
					}
					/* @ts-ignore */
					resolve.apply(null, args);
				},
				error: reject
			})
		);
	},
	/**
	 *
	 * @param {*} cssname
	 * @returns
	 */
	loadCss: function (cssname: string) {
		const cssPath = `${cssname}`;
		let $link = $("<link/>", { rel: "stylesheet", type: "text/css" });
		$link.appendTo($("head"));
		/* @ts-ignore */
		$link[0].href = `${cssPath}?_t=${Date.now()}`;
		/* destroy ÁöÑÊó∂ÂÄôÁßªÈô§Â∑≤Âä†ËΩΩÁöÑÊ®°ÂùócssÔºåÈÖåÊÉÖ‰ΩøÁî® */
		return () => {
			$link.remove();
			/* @ts-ignore */
			$link = null;
		};
	},

	/**
	 *
	 * @param date type dayjs.ConfigType = string | number | Date | dayjs.Dayjs | null | undefined
	 * @param format ÈªòËÆ§ "YYYY-MM-DD" 1Ôºö"YYYY-MM-DD HH:mm:ss"
	 * @returns
	 */
	dateFormat: function (date: dayjs.ConfigType, format = "YYYY-MM-DD") {
		if (typeof date === "number") {
			date = dayjs.unix(date);
		}
		/* @ts-ignore */
		if (format === 1) {
			format = "YYYY-MM-DD HH:mm:ss";
		}
		const label = dayjs(date).format(format);
		return label === privateLodash.WORDS.INVALID_DATE ? "--" : label;
	},

	keepDecimals: function (val: number, fractionDigits: 2) {
		let num = Number((val * 100) / 1024 / 100).toFixed(fractionDigits);
		if (num === "NaN") {
			num = "-";
		}
		return num;
	},

	valueToLabel: function (value: string, options: any[]) {
		const target = privateLodash.find(options, {
			value
		});
		if (target) {
			return target.label;
		} else {
			return "--";
		}
	},
	timego: function (timestamp: any) {
		let minutes, hours, days, seconds, mouth, year;
		/* @ts-ignore */
		const timeNow = parseInt(new Date().getTime() / 1000);
		seconds = timeNow - timestamp;

		if (seconds > 86400 * 30 * 12) {
			/* @ts-ignore */
			year = parseInt(seconds / (86400 * 30 * 12));
		} else {
			year = 0;
		}

		if (seconds > 86400 * 30) {
			/* @ts-ignore */
			mouth = parseInt(seconds / (86400 * 30));
		} else {
			mouth = 0;
		}
		if (seconds > 86400) {
			/* @ts-ignore */
			days = parseInt(seconds / 86400);
		} else {
			days = 0;
		}
		if (seconds > 3600) {
			/* @ts-ignore */
			hours = parseInt(seconds / 3600);
		} else {
			hours = 0;
		}
		/* @ts-ignore */
		minutes = parseInt(seconds / 60);
		if (year > 0) {
			return year + "Âπ¥Ââç";
		} else if (mouth > 0 && year <= 0) {
			return mouth + "ÊúàÂâç";
		} else if (days > 0 && mouth <= 0) {
			return days + "Â§©Ââç";
		} else if (days <= 0 && hours > 0) {
			return hours + "Â∞èÊó∂Ââç";
		} else if (hours <= 0 && minutes > 0) {
			return minutes + "ÂàÜÈíüÂâç";
		} else if (minutes <= 0 && seconds > 0) {
			if (seconds < 30) {
				return "ÂàöÂàö";
			} else {
				return seconds + "ÁßíÂâç";
			}
		} else {
			return "ÂàöÂàö";
		}
	},
	htmlFilter: (html: string) => {
		if (!html) return;
		let reg = /<\/?.+?\/?>/g;
		return html.replace(reg, "") || "";
	},
	/**
	 * ÂØπobject set Êàñ get Â±ûÊÄßÂÄºÔºå‰øùËØÅ‰∏ç‰ºöundefined
	 * MutatingProps(state,"user.role.public",false);
	 * @param item
	 * @param prop
	 * @param val
	 * @returns
	 */
	MutatingProps: (item: any, prop: string, val = null) => {
		item = item || {};
		const propArray = prop.split(".");
		let key = "";
		let nextItem = item;

		const setVal = () => {
			while (((key as any) = propArray.shift())) {
				if (!key) {
					debugger;
				}
				/* Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÈ°πÔºåÂ∞±ËµãÂÄºÂêéÈÄÄÂá∫ */
				if (propArray.length === 0) {
					nextItem[key] = val;
					return;
				} else {
					/* ÁªßÁª≠Âæ™ÁéØÔºåÂ¶ÇÊûú‰∏≠Èó¥ÊúâundefinedÔºåÊ∑ªÂä†‰∏≠Èó¥È°π */
					const _nextItem = nextItem[key];
					if (!_nextItem) {
						nextItem[key] = {};
					}
					nextItem = nextItem[key];
				}
			}
		};

		const getVal = () => {
			while (((key as any) = propArray.shift())) {
				const _nextItem = nextItem[key];
				if (!_nextItem) {
					return nextItem[key];
				} else {
					if (propArray.length === 0) {
						return _nextItem;
					} else {
						nextItem = nextItem[key];
					}
				}
			}
			return nextItem;
		};

		/* Â¶ÇÊûúÊúâËæìÂÖ• Á±ª‰ººjQuery val() */
		if (
			val ||
			privateLodash.isString(val) ||
			privateLodash.isBoolean(val) ||
			(privateLodash.isNumber(val) && !privateLodash.isNaN(val))
		) {
			setVal();
		} else {
			return getVal();
		}
		return item;
	}
};

export { privateLodash as xU };
